- name: Install basic ansible dependencies
  ansible.builtin.raw: pkg install -y python doas gtar unzip
  # TODO fix changed_when to properly detect change
  changed_when: true
  tags: always

# TODO deal with properly setting password
- name: Create ansible bootstrapping setup user
  ansible.builtin.user:
    name: ansible
    append: true
    groups: wheel
  tags: always

# local key just for testing
- name: Add control host's ssh key to setup user's authorized keys
  ansible.posix.authorized_key:
    user: ansible
    key: "{{ lookup('file', '/home/siva/.ssh/id_ed25519.pub') }}"
    exclusive: true
  tags: always

- name: Add setup user to doas configuration
  ansible.builtin.copy:
    content: "permit nopass :wheel\n"
    dest: /usr/local/etc/doas.conf
    owner: root
    group: wheel
    mode: '0600'
  tags: always
