- name: Create ZFS dataset for the top level jails filesystem
  community.general.zfs:
    name: zroot/jails
    state: present
    extra_zfs_properties:
      mountpoint: '/email'

- name: Create ZFS dataset for top level container for email-related filesystems
  community.general.zfs:
    name: zroot/email
    state: present
    extra_zfs_properties:
      atime: 'off'
      canmount: 'off'
      compression: 'zstd'
      # TODO figure out how to enable encryption properly
      # turning off for now
      encryption: 'off'
      exec: 'off'
      mountpoint: '/email'
      setuid: 'off'

- name: Create ZFS datasets for all email-related filesystems
  community.general.zfs:
    name: 'zroot{{ item.path }}'
    state: present
    extra_zfs_properties:
      canmount: 'on'
  loop: '{{ special_zfs_datasets }}'

- name: Create unix users that will be mapped on both jailhost and jails
  ansible.builtin.user:
    name: '{{ item.name }}'
    comment: '{{ item.comment }}'
    uid: '{{ item.uid }}'
    home: '{{ item.host_home_dir }}'
    shell: /usr/sbin/nologin
  loop: '{{ host_jails_mapped_users }}'

- name: Create a ZFS dataset for each jail
  community.general.zfs:
    name: 'zroot/jails/{{ item }}'
    state: present
  loop: '{{ groups["jails"] }}'

- name: Change ownership of newly created ZFS datasets
  ansible.builtin.file:
    name: '{{ item.path }}'
    state: directory
    recurse: true
    owner: mlmmj
    group: mlmmj
  loop: '{{ special_zfs_datasets }}'

- name: Create all missing directories on jailhost
  ansible.builtin.file:
    path: '{{ item }}'
    state: directory
    mode: '0755'
  loop:
    - /etc/jail_fstabs
    - /tmp/base_jail

# TODO move back to downloading from freebsd.org once fully tested
# - name: Download FreeBSD base system archive to local filesystem
#   ansible.builtin.get_url:
#     url: 'https://download.freebsd.org/ftp/releases/amd64/{{ freebsd_version }}/base.txz'
#     dest: /tmp/base.tar.xz
#     owner: root
#     group: wheel
#     mode: '0644'
#   tags: initial

- name: Unarchive (thick) base jail to temporary location
  ansible.builtin.unarchive:
    src: base.tar.xz
    dest: /tmp/base_jail
  tags: initial

- name: Create all missing directories in base jail
  ansible.builtin.file:
    path: '{{ item }}'
    state: directory
    mode: '0755'
  loop:
    - /tmp/base_jail/usr/local/etc/pkg/repos
    - /tmp/base_jail/usr/local/poudriere_repo
    - /tmp/base_jail/root/.ssh

- name: Populate common /etc files into base jail
  ansible.builtin.template:
    src: '{{ item.src }}'
    dest: '/tmp/base_jail/etc/{{ item.path | replace(".j2", "") }}'
    mode: '0644'
    owner: root
    group: wheel
  with_community.general.filetree: '{{ "templates/common_etc/" }}'
  when: item.state == 'file'

- name: Copy pkg repo config to base jail
  ansible.builtin.copy:
    src: /usr/local/etc/pkg/repos/FreeBSD.conf
    remote_src: true
    dest: /tmp/base_jail/usr/local/etc/pkg/repos/
    mode: '0644'
    owner: root
    group: wheel

- name: Add control host's ssh key to base jail
  ansible.posix.authorized_key:
    user: root
    key: "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAINqa5qTRGfyJckSBOXWyqdSC4tortF5Nc0O6kQFkORFi siva@think"
    path: /tmp/base_jail/root/.ssh/authorized_keys
    exclusive: true

- name: Clone (thick) base jail to installed locations
  ansible.builtin.copy:
    src: /tmp/base_jail/
    remote_src: true
    dest: '/jails/{{ hostvars[item].inventory_hostname_short }}/'
  loop: '{{ groups["jails"] }}'

- name: Populate jailhost /etc files
  ansible.builtin.template:
    src: '{{ item.src }}'
    dest: '/etc/{{ item.path | replace(".j2", "") }}'
    mode: '0644'
    owner: root
    group: wheel
  with_community.general.filetree: '{{ "templates/jailhost_etc/" }}'
  when: item.state == 'file'

- name: Copy the common fstab for each jail
  ansible.builtin.template:
    src: 'jail_fstabs/{{ item }}.fstab'
    dest: '/etc/jail_fstabs/{{ item }}.fstab'
    owner: root
    group: wheel
    mode: '0644'
  vars:
    setup_jailhost_fstab_jail: '{{ item }}'
  loop: '{{ groups["jails"] }}'

# TODO enable once everything is figured out
# - name: Enable jail service
#   ansible.builtin.service:
#     name: jail
#     enabled: true
#
# - name: Set list of enabled jails
#   ansible.builtin.lineinfile:
#     path: /etc/rc.conf
#     line: 'jail_list="certauth"'

# TODO unnecessary for now since we've hardcoded IP addresses.
# Commenting out for now.
# - name: Add all jails to the inventory
#   ansible.builtin.add_host:
#     name: 'jail_{{ item.name }}'
#     ansible_host: '{{ item.ipaddr }}'
#     groups:
#       - jails
#   loop: '{{ all_jails }}'

# TODO file an ansible bug: ansible.builtin.service doesn't start the jail
# service
- name: Start all enabled jails
  ansible.builtin.command: 'service jail onerestart'

# TODO pending on 'https://bugs.freebsd.org/bugzilla/show_bug.cgi?id=271069'
- name: WORKAROUND restart all services inside each jail for good measure
  ansible.builtin.shell: 'jls name | xargs -L1 -I% service -j % {{ item }} restart'
  loop:
    - syslogd
    - sshd
